name: Scheduled Builds & Promotions

# Nightly: full rebuild + smoke test  → :17-nightly, :17-nightly-YYYYMMDD
# Weekly:  retag nightly → weekly     → :17-weekly,  :17-weekly-YYYYWWW
# Monthly: retag weekly  → stable     → :17-stable,  :17-stable-YYYYMM

on:
  schedule:
    - cron: '0 3 * * *'    # Nightly at 3 AM UTC
    - cron: '0 5 * * 1'    # Weekly on Monday at 5 AM UTC
    - cron: '0 7 1 * *'    # Monthly on 1st at 7 AM UTC
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - nightly
          - promote-weekly
          - promote-stable

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ── Nightly: full rebuild with latest packages + smoke test ──
  nightly:
    if: >-
      github.event.schedule == '0 3 * * *' ||
      (github.event_name == 'workflow_dispatch' && inputs.action == 'nightly')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build image with docker compose
        run: docker compose build

      - name: Start the stack
        run: docker compose up -d

      - name: Wait for MariaDB to be healthy
        run: |
          echo "Waiting for MariaDB health check..."
          retries=30
          until [ "$(docker inspect --format='{{.State.Health.Status}}' "$(docker compose ps -q db)")" = "healthy" ]; do
            retries=$((retries - 1))
            if [ "$retries" -le 0 ]; then
              echo "::error::MariaDB did not become healthy"
              docker compose logs db
              exit 1
            fi
            sleep 5
          done
          echo "MariaDB is healthy."

      - name: Wait for FreePBX to start
        timeout-minutes: 12
        run: |
          echo "Waiting for FreePBX entrypoint to finish..."
          retries=120
          until docker compose logs freepbx 2>&1 | grep -q "FreePBX ready"; do
            retries=$((retries - 1))
            if [ "$retries" -le 0 ]; then
              echo "::error::FreePBX did not start in time"
              docker compose logs freepbx
              exit 1
            fi
            if docker compose logs freepbx 2>&1 | grep -q "freepbx_settings.*doesn't exist"; then
              echo "::error::freepbx_settings table missing — SQL dump is bad"
              docker compose logs freepbx
              exit 1
            fi
            docker compose logs freepbx 2>&1 | tail -1
            sleep 5
          done
          echo "FreePBX entrypoint completed."

      - name: Smoke test — verify critical DB table exists
        run: |
          docker compose exec -T db mariadb -ufreepbx -pchangeme_fpbx asterisk \
            -e "SELECT COUNT(*) AS setting_count FROM freepbx_settings;" \
            || { echo "::error::freepbx_settings table is missing"; docker compose logs freepbx; exit 1; }

      - name: Smoke test — HTTP 200 from Apache
        run: |
          retries=12
          until curl -sf -o /dev/null -w '%{http_code}' http://localhost:80; do
            retries=$((retries - 1))
            if [ "$retries" -le 0 ]; then
              echo "::error::Apache did not return HTTP 200"
              docker compose logs freepbx | tail -40
              exit 1
            fi
            sleep 5
          done
          echo "HTTP check passed."

      - name: Tear down
        if: always()
        run: docker compose down -v

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag and push nightly
        run: |
          DATE=$(date +%Y%m%d)
          SRC="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          docker tag "$SRC" "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:17-nightly"
          docker tag "$SRC" "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:17-nightly-${DATE}"
          docker push "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:17-nightly"
          docker push "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:17-nightly-${DATE}"

      - name: Dump logs on failure
        if: failure()
        run: docker compose logs --tail=100

  # ── Weekly: promote tested nightly → weekly ──
  promote-weekly:
    if: >-
      github.event.schedule == '0 5 * * 1' ||
      (github.event_name == 'workflow_dispatch' && inputs.action == 'promote-weekly')
    runs-on: ubuntu-latest
    permissions:
      packages: write

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Promote nightly → weekly
        run: |
          WEEK=$(date +%YW%V)
          docker buildx imagetools create \
            -t "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:17-weekly" \
            -t "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:17-weekly-${WEEK}" \
            "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:17-nightly"

  # ── Monthly: promote weekly → stable ──
  promote-stable:
    if: >-
      github.event.schedule == '0 7 1 * *' ||
      (github.event_name == 'workflow_dispatch' && inputs.action == 'promote-stable')
    runs-on: ubuntu-latest
    permissions:
      packages: write

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Promote weekly → stable
        run: |
          MONTH=$(date +%Y%m)
          docker buildx imagetools create \
            -t "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:17-stable" \
            -t "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:17-stable-${MONTH}" \
            "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:17-weekly"
