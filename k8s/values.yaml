# bjw-s app-template values for FreePBX on k3s
# Install: helm install freepbx bjw-s/app-template -f values.yaml
#
# Requires:
#   helm repo add bjw-s https://bjw-s.github.io/helm-charts
#   mariadb-operator + k8s/mariadb.yaml applied first

controllers:
  main:
    containers:
      main:
        image:
          repository: ghcr.io/00o-sh/fpbx-docker
          tag: latest
        env:
          DB_HOST: freepbx-mariadb
          DB_PORT: "3306"
          DB_USER: freepbx
          DB_NAME: asterisk
          DB_CDR_NAME: asteriskcdrdb
          DB_PASS:
            valueFrom:
              secretKeyRef:
                name: freepbx-mariadb-password
                key: password
        probes:
          liveness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /admin/
                port: 80
              periodSeconds: 10
          readiness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /admin/
                port: 80
              periodSeconds: 5
          startup:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /admin/
                port: 80
              failureThreshold: 30
              periodSeconds: 10
        securityContext:
          capabilities:
            add:
              - NET_ADMIN
    pod:
      # hostNetwork required for SIP (5060) and RTP (10000-20000) traffic.
      # Without it, UDP NAT traversal is extremely fragile.
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      terminationGracePeriodSeconds: 60

service:
  main:
    controller: main
    type: ClusterIP
    ports:
      http:
        port: 80

persistence:
  asterisk-etc:
    type: persistentVolumeClaim
    accessMode: ReadWriteOnce
    size: 256Mi
    globalMounts:
      - path: /etc/asterisk
  asterisk-lib:
    type: persistentVolumeClaim
    accessMode: ReadWriteOnce
    size: 2Gi
    globalMounts:
      - path: /var/lib/asterisk
  asterisk-spool:
    type: persistentVolumeClaim
    accessMode: ReadWriteOnce
    size: 2Gi
    globalMounts:
      - path: /var/spool/asterisk
  asterisk-log:
    type: persistentVolumeClaim
    accessMode: ReadWriteOnce
    size: 1Gi
    globalMounts:
      - path: /var/log/asterisk
